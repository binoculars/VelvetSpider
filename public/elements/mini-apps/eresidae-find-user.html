<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/core-ajax/core-ajax.html">
<link rel="import" href="/bower_components/core-input/core-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-input/paper-input-decorator.html">

<polymer-element name="eresidae-find-user">
    <template>
        <core-ajax auto
                   url="/api/listServices"
                   params=""
                   handleAs="json"
                   class="services"
                   on-core-response="{{servicesCoreResponse}}">
        </core-ajax>
        <paper-input-decorator label="[[ exampleValues ? 'E.g. ' + exampleValues : '']]"
                               floatingLabel="[[ exampleValues != null ]]"
                               value="{{val}}"
                               isInvalid="true">
            <input is="core-input"
                   value="{{val}}"
                   on-input="{{usernameInput}}"
                   required="true"/>
        </paper-input-decorator>
        
        
        <template repeat="{{services}}">
            <div horizontal layout flex>
                <div flex>{{name}}</div>
                <div flex>{{value}}</div>
                <div flex>
                    <template if="{{ id == 'github' }}">
                        <template repeat="{{ res.body.items }}">
                            <a href="{{url}}"><img src="{{avatar_url}}" style="width: 50px; height: 50px;"> {{login}}</a><br>
                        </template>
                    </template>
                    <template if="{{ id == 'google' }}">
                        <template repeat="{{ res.body.items }}">
                            <a href="{{url}}"><img src="{{image.url}}"> {{displayName}}</a><br>
                        </template>
                    </template>
                    <template if="{{ id == 'instagram' }}">
                        <template repeat="{{ res.body.data }}">
                            <a href="//instagram.com/{{username}}"><img src="{{profile_picture}}" style="width: 50px; height: 50px;"> {{full_name}}</a><br>
                        </template>
                    </template>
                </div>
            </div>
            <core-ajax
                url="/api/service/[[id]]"
                params="{{params}}"
                handleAs="json"
                on-core-response="{{apiResponse}}"
                class="api"
                response={{res}}>
            </core-ajax>
            
        </template>
        
        <paper-button raised class="inverted" on-click="{{go}}">Go!</paper-button>
    </template>
    <script>
        Polymer({
            usernameInput: function() {
                for (var i = 0; i < this.services.length; i++) {
                    
                    this.services[i].value = this.services[i].replaces ? this.services[i].url.replace(this.services[i].replaces, this.val) : this.services[i].url;
                    
                    this.services[i].params = {
                        url: this.services[i].value,
                        req: '{}'
                    };
                    
                    if (this.services[i].parameter) {
                        var req = {};
                        req[this.services[i].parameter] = this.val;
                        this.services[i].params.req = JSON.stringify(req);
                    }
                }
            },
            
            services: [
                {
                    "id": "github",
                    "name": "GitHub",
                    "url": "https://api.github.com/search/users",
                    "parameter": "q"
                },
                {
                    "id": "google",
                    "name": "Google+",
                    "url": "https://www.googleapis.com/plus/v1/people",
                    "parameter": "query"
                },
                {
                    "id": "instagram",
                    "name": "Instagram",
                    "url": "https://api.instagram.com/v1/users/search",
                    "parameter": "q"
                }
            ],
            
            apiResponse: function(e) {
                console.log(e.detail.response);
                e.detail.response.body = JSON.parse(e.detail.response.body);
            },
            
            go: function() {
                [].map.call(this.shadowRoot.querySelectorAll('.api'), function(api) {
                    api.go();
                });
            }
        });
    </script>
</polymer-element>